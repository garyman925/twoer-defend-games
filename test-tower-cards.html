<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塔卡片系統測試</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #222;
            color: white;
            font-family: Arial, sans-serif;
        }
        #game-container {
            border: 2px solid #444;
            margin: 20px 0;
        }
        .info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .controls {
            background: #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #666;
            color: white;
            border: 1px solid #888;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <h1>塔卡片系統測試</h1>
    
    <div class="info">
        <h3>測試功能：</h3>
        <ul>
            <li>✅ 底部塔卡片選擇區域</li>
            <li>✅ 卡片 hover 效果（放大、上移）</li>
            <li>✅ 卡片選中高亮（綠色邊框）</li>
            <li>✅ 點擊卡片開始塔放置模式</li>
            <li>✅ 金錢系統集成</li>
            <li>✅ 卡片可用性更新（基於金錢）</li>
        </ul>
    </div>

    <div class="controls">
        <h3>測試控制：</h3>
        <button onclick="addMoney(100)">+100 金錢</button>
        <button onclick="addMoney(500)">+500 金錢</button>
        <button onclick="spendMoney(200)">-200 金錢</button>
        <button onclick="resetMoney()">重置金錢</button>
        <button onclick="toggleCards()">切換卡片顯示</button>
    </div>

    <div id="game-container"></div>

    <div class="info">
        <h3>操作說明：</h3>
        <ul>
            <li>🖱️ 將滑鼠懸停在卡片上查看 hover 效果</li>
            <li>🖱️ 點擊卡片選擇塔類型</li>
            <li>🖱️ 在地圖上點擊放置塔</li>
            <li>⌨️ 按 ESC 取消放置</li>
            <li>💰 使用上方按鈕測試金錢系統</li>
        </ul>
    </div>

    <script src="node_modules/phaser/dist/phaser.min.js"></script>
    <script>
        // 模擬玩家金錢
        let playerMoney = 1000;
        
        // 金錢控制函數
        function addMoney(amount) {
            playerMoney += amount;
            updateMoneyDisplay();
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].towerCardUI) {
                window.game.scene.scenes[0].towerCardUI.updateCardAvailability(playerMoney);
            }
        }
        
        function spendMoney(amount) {
            playerMoney = Math.max(0, playerMoney - amount);
            updateMoneyDisplay();
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].towerCardUI) {
                window.game.scene.scenes[0].towerCardUI.updateCardAvailability(playerMoney);
            }
        }
        
        function resetMoney() {
            playerMoney = 1000;
            updateMoneyDisplay();
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].towerCardUI) {
                window.game.scene.scenes[0].towerCardUI.updateCardAvailability(playerMoney);
            }
        }
        
        function updateMoneyDisplay() {
            const moneyDisplay = document.getElementById('money-display');
            if (moneyDisplay) {
                moneyDisplay.textContent = `金錢: $${playerMoney}`;
            }
        }
        
        function toggleCards() {
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].towerCardUI) {
                const cards = window.game.scene.scenes[0].towerCardUI.cards;
                cards.forEach(card => {
                    card.container.setVisible(!card.container.visible);
                });
            }
        }

        class TowerCardTestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TowerCardTestScene' });
                this.towerCardUI = null;
                this.player = { money: playerMoney };
            }

            preload() {
                console.log('🔄 開始加載資源...');
                
                // 加載塔精靈圖集
                this.load.atlas('tower-sprites', 'assets/sprites/towers/tower-sprite.png', 'assets/sprites/towers/tower-sprite.json');
                
                console.log('📁 資源加載完成');
            }

            create() {
                console.log('🎮 開始創建場景...');
                
                // 創建簡單的背景
                this.add.rectangle(640, 400, 1280, 800, 0x2c3e50);
                
                // 創建塔卡片UI
                this.towerCardUI = new TowerCardUITest(this);
                this.towerCardUI.create();
                
                // 設置事件監聽
                this.events.on('towerCardSelected', this.onTowerCardSelected, this);
                
                // 創建金錢顯示
                this.createMoneyDisplay();
                
                console.log('✅ 場景創建完成');
            }
            
            createMoneyDisplay() {
                const moneyText = this.add.text(20, 20, `金錢: $${this.player.money}`, {
                    fontSize: '24px',
                    fill: '#ffd93d',
                    fontWeight: 'bold',
                    backgroundColor: '#000000',
                    padding: { x: 10, y: 5 }
                });
                moneyText.setDepth(2000);
                
                // 將元素添加到 DOM 以便外部控制
                const moneyElement = document.createElement('div');
                moneyElement.id = 'money-display';
                moneyElement.textContent = `金錢: $${this.player.money}`;
                moneyElement.style.position = 'absolute';
                moneyElement.style.top = '20px';
                moneyElement.style.left = '20px';
                moneyElement.style.color = '#ffd93d';
                moneyElement.style.fontSize = '18px';
                moneyElement.style.fontWeight = 'bold';
                moneyElement.style.backgroundColor = 'rgba(0,0,0,0.7)';
                moneyElement.style.padding = '5px 10px';
                moneyElement.style.borderRadius = '5px';
                document.body.appendChild(moneyElement);
            }
            
            onTowerCardSelected(data) {
                const { type, name, cost } = data;
                console.log(`🎯 選擇了塔卡片: ${name} (${type}) - 價格: $${cost}`);
                
                if (this.player.money >= cost) {
                    console.log(`✅ 開始放置 ${type} 塔`);
                    // 這裡可以添加塔放置邏輯
                } else {
                    console.warn(`❌ 金錢不足，無法購買 ${name} (需要 $${cost})`);
                }
            }
        }

        // 簡化版的 TowerCardUI 用於測試
        class TowerCardUITest {
            constructor(scene) {
                this.scene = scene;
                this.cards = [];
                this.selectedCard = null;
                this.cardSpacing = 20;
                this.cardWidth = 97;
                this.cardHeight = 129;
                this.uiHeight = 130;
                
                this.towerTypes = [
                    { type: 'basic', name: '基礎塔', cardFrame: 'basic-tower-card.png', cost: 50 },
                    { type: 'cannon', name: '加農炮', cardFrame: 'canon-tower-card.png', cost: 100 },
                    { type: 'laser', name: '激光塔', cardFrame: 'laser-tower-card.png', cost: 150 },
                    { type: 'ice', name: '冰凍塔', cardFrame: 'ice-tower-card.png', cost: 120 }
                ];
            }

            create() {
                console.log('🎴 創建塔卡片選擇區域...');
                
                const { width, height } = this.scene.scale.gameSize;
                const startX = this.cardSpacing;
                const cardY = height - this.uiHeight + (this.uiHeight - this.cardHeight) / 2;
                
                // 創建背景
                this.createBackground(width, height);
                
                // 創建每個塔卡片
                this.towerTypes.forEach((towerConfig, index) => {
                    const cardX = startX + index * (this.cardWidth + this.cardSpacing);
                    const card = this.createTowerCard(cardX, cardY, towerConfig, index);
                    this.cards.push(card);
                });
                
                console.log(`✅ 創建了 ${this.cards.length} 個塔卡片`);
            }

            createBackground(width, height) {
                this.background = this.scene.add.rectangle(
                    width / 2, 
                    height - this.uiHeight / 2, 
                    width, 
                    this.uiHeight, 
                    0x000000, 
                    0.8
                );
                this.background.setDepth(1000);
                
                this.border = this.scene.add.rectangle(
                    width / 2,
                    height - this.uiHeight,
                    width,
                    2,
                    0x444444
                );
                this.border.setDepth(1001);
            }

            createTowerCard(x, y, towerConfig, index) {
                const card = {
                    type: towerConfig.type,
                    name: towerConfig.name,
                    cost: towerConfig.cost,
                    cardFrame: towerConfig.cardFrame,
                    index: index,
                    container: null,
                    sprite: null,
                    shadow: null,
                    highlight: null,
                    costText: null,
                    isSelected: false
                };

                card.container = this.scene.add.container(x, y);
                card.container.setDepth(1002);
                card.container.setSize(this.cardWidth, this.cardHeight);
                card.container.setInteractive();

                // 陰影
                card.shadow = this.scene.add.rectangle(2, 2, this.cardWidth, this.cardHeight, 0x000000, 0.3);
                card.shadow.setOrigin(0.5);
                card.container.add(card.shadow);

                // 卡片精靈
                card.sprite = this.scene.add.image(0, 0, 'tower-sprites', card.cardFrame);
                card.sprite.setOrigin(0.5);
                card.container.add(card.sprite);

                // 高亮效果
                card.highlight = this.scene.add.rectangle(0, 0, this.cardWidth + 8, this.cardHeight + 8, 0x00ff00, 0);
                card.highlight.setStrokeStyle(3, 0x00ff00, 0.8);
                card.highlight.setOrigin(0.5);
                card.highlight.setVisible(false);
                card.container.add(card.highlight);

                // 價格文字
                card.costText = this.scene.add.text(0, this.cardHeight / 2 - 10, `$${card.cost}`, {
                    fontSize: '14px',
                    fill: '#ffd93d',
                    fontWeight: 'bold',
                    backgroundColor: '#000000',
                    padding: { x: 4, y: 2 }
                });
                card.costText.setOrigin(0.5);
                card.container.add(card.costText);

                // 交互事件
                this.addCardInteractions(card);

                return card;
            }

            addCardInteractions(card) {
                card.container.on('pointerover', () => {
                    if (!card.isSelected) {
                        card.sprite.setScale(1.1);
                        card.shadow.setScale(1.1);
                        card.container.y -= 5;
                    }
                });

                card.container.on('pointerout', () => {
                    if (!card.isSelected) {
                        card.sprite.setScale(1.0);
                        card.shadow.setScale(1.0);
                        card.container.y += 5;
                    }
                });

                card.container.on('pointerdown', () => {
                    this.selectCard(card);
                });
            }

            selectCard(selectedCard) {
                if (this.selectedCard) {
                    this.deselectCard(this.selectedCard);
                }

                selectedCard.isSelected = true;
                selectedCard.highlight.setVisible(true);
                selectedCard.sprite.setScale(1.1);
                selectedCard.shadow.setScale(1.1);
                selectedCard.container.y -= 5;

                this.selectedCard = selectedCard;

                console.log(`🎯 選擇了塔: ${selectedCard.name} (${selectedCard.type})`);

                this.scene.events.emit('towerCardSelected', {
                    type: selectedCard.type,
                    name: selectedCard.name,
                    cost: selectedCard.cost
                });
            }

            deselectCard(card) {
                card.isSelected = false;
                card.highlight.setVisible(false);
                card.sprite.setScale(1.0);
                card.shadow.setScale(1.0);
                card.container.y += 5;
            }

            deselectAll() {
                if (this.selectedCard) {
                    this.deselectCard(this.selectedCard);
                    this.selectedCard = null;
                }
            }

            updateCardAvailability(playerMoney) {
                this.cards.forEach(card => {
                    const canAfford = playerMoney >= card.cost;
                    card.sprite.setAlpha(canAfford ? 1.0 : 0.5);
                    card.costText.setAlpha(canAfford ? 1.0 : 0.5);
                    
                    if (!canAfford && card.isSelected) {
                        this.deselectAll();
                    }
                });
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 962,
            parent: 'game-container',
            backgroundColor: '#2c3e50',
            scene: TowerCardTestScene
        };

        const game = new Phaser.Game(config);
        window.game = game;
    </script>
</body>
</html>
