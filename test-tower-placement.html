<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”æ”¾ç½®ç³»çµ±æ¸¬è©¦</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #222;
            color: white;
            font-family: Arial, sans-serif;
        }
        #game-container {
            border: 2px solid #444;
            margin: 20px 0;
        }
        .info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .controls {
            background: #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #666;
            color: white;
            border: 1px solid #888;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <h1>å¡”æ”¾ç½®ç³»çµ±æ¸¬è©¦</h1>
    
    <div class="info">
        <h3>æ¸¬è©¦ç›®æ¨™ï¼š</h3>
        <ul>
            <li>âœ… ç©å®¶æœ‰åˆå§‹é‡‘éŒ¢ (500)</li>
            <li>âœ… é»æ“Šå¡”å¡ç‰‡è§¸ç™¼æ”¾ç½®æ¨¡å¼</li>
            <li>âœ… é¡¯ç¤ºç¶²æ ¼å’Œé è¦½å¡”</li>
            <li>âœ… å¯ä»¥åœ¨åœ°åœ–ä¸Šæ”¾ç½®å¡”</li>
            <li>âœ… æ”¾ç½®å¾Œæ‰£é™¤é‡‘éŒ¢</li>
        </ul>
    </div>

    <div class="controls">
        <h3>æ¸¬è©¦æ§åˆ¶ï¼š</h3>
        <button onclick="addMoney(100)">+100 é‡‘éŒ¢</button>
        <button onclick="addMoney(500)">+500 é‡‘éŒ¢</button>
        <button onclick="spendMoney(200)">-200 é‡‘éŒ¢</button>
        <button onclick="resetMoney()">é‡ç½®é‡‘éŒ¢</button>
        <button onclick="showPlayerInfo()">é¡¯ç¤ºç©å®¶ä¿¡æ¯</button>
    </div>

    <div id="game-container"></div>

    <div class="info">
        <h3>æ“ä½œèªªæ˜ï¼š</h3>
        <ul>
            <li>ğŸ–±ï¸ é»æ“Šåº•éƒ¨å¡”å¡ç‰‡é¸æ“‡å¡”é¡å‹</li>
            <li>ğŸ–±ï¸ åœ¨åœ°åœ–ä¸Šé»æ“Šæ”¾ç½®å¡”</li>
            <li>âŒ¨ï¸ æŒ‰ ESC å–æ¶ˆæ”¾ç½®</li>
            <li>ğŸ’° ä½¿ç”¨ä¸Šæ–¹æŒ‰éˆ•æ¸¬è©¦é‡‘éŒ¢ç³»çµ±</li>
        </ul>
    </div>

    <script src="node_modules/phaser/dist/phaser.min.js"></script>
    <script>
        // æ¨¡æ“¬ç©å®¶é‡‘éŒ¢
        let playerMoney = 500;
        
        // é‡‘éŒ¢æ§åˆ¶å‡½æ•¸
        function addMoney(amount) {
            playerMoney += amount;
            updateMoneyDisplay();
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].player) {
                window.game.scene.scenes[0].player.money += amount;
                console.log(`ğŸ’° æ·»åŠ  $${amount}ï¼Œç¸½é‡‘éŒ¢: $${window.game.scene.scenes[0].player.money}`);
            }
        }
        
        function spendMoney(amount) {
            playerMoney = Math.max(0, playerMoney - amount);
            updateMoneyDisplay();
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].player) {
                window.game.scene.scenes[0].player.money = Math.max(0, window.game.scene.scenes[0].player.money - amount);
                console.log(`ğŸ’¸ èŠ±è²» $${amount}ï¼Œå‰©é¤˜é‡‘éŒ¢: $${window.game.scene.scenes[0].player.money}`);
            }
        }
        
        function resetMoney() {
            playerMoney = 500;
            updateMoneyDisplay();
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].player) {
                window.game.scene.scenes[0].player.money = 500;
                console.log(`ğŸ”„ é‡ç½®é‡‘éŒ¢: $${window.game.scene.scenes[0].player.money}`);
            }
        }
        
        function updateMoneyDisplay() {
            const moneyDisplay = document.getElementById('money-display');
            if (moneyDisplay) {
                moneyDisplay.textContent = `é‡‘éŒ¢: $${playerMoney}`;
            }
        }
        
        function showPlayerInfo() {
            if (window.game && window.game.scene && window.game.scene.scenes[0] && window.game.scene.scenes[0].player) {
                const player = window.game.scene.scenes[0].player;
                console.log('ğŸ‘¤ ç©å®¶ä¿¡æ¯:', {
                    health: player.health,
                    maxHealth: player.maxHealth,
                    money: player.money,
                    isAlive: player.isAlive
                });
            } else {
                console.log('âŒ ç©å®¶å°è±¡ä¸å­˜åœ¨');
            }
        }

        class TowerPlacementTestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TowerPlacementTestScene' });
                this.player = null;
                this.towerCardUI = null;
                this.towerPlacementSystem = null;
            }

            preload() {
                console.log('ğŸ”„ é–‹å§‹åŠ è¼‰è³‡æº...');
                
                // è¼‰å…¥å¡”ç²¾éˆåœ–é›†
                this.load.atlas('tower-sprites', 'assets/sprites/towers/tower-sprite.png', 'assets/sprites/towers/tower-sprite.json');
                
                console.log('ğŸ“ è³‡æºåŠ è¼‰å®Œæˆ');
            }

            create() {
                console.log('ğŸ® é–‹å§‹å‰µå»ºå ´æ™¯...');
                
                // å‰µå»ºèƒŒæ™¯
                this.add.rectangle(640, 400, 1280, 800, 0x2c3e50);
                
                // å‰µå»ºç©å®¶
                this.createPlayer();
                
                // å‰µå»ºå¡”å¡ç‰‡UI
                this.createTowerCardUI();
                
                // å‰µå»ºå¡”æ”¾ç½®ç³»çµ±
                this.createTowerPlacementSystem();
                
                // å‰µå»ºé‡‘éŒ¢é¡¯ç¤º
                this.createMoneyDisplay();
                
                console.log('âœ… å ´æ™¯å‰µå»ºå®Œæˆ');
            }
            
            createPlayer() {
                console.log('ğŸ‘¤ å‰µå»ºç©å®¶...');
                
                // æ¨¡æ“¬ Player é¡
                this.player = {
                    health: 100,
                    maxHealth: 100,
                    money: 500, // åˆå§‹é‡‘éŒ¢
                    isAlive: true,
                    x: 640,
                    y: 400
                };
                
                // å‰µå»ºç©å®¶è¦–è¦ºè¡¨ç¤º
                const playerSprite = this.add.circle(640, 400, 20, 0x00ffff);
                playerSprite.setStrokeStyle(3, 0xffffff);
                
                console.log('âœ… ç©å®¶å‰µå»ºå®Œæˆï¼Œé‡‘éŒ¢:', this.player.money);
            }
            
            createTowerCardUI() {
                console.log('ğŸ´ å‰µå»ºå¡”å¡ç‰‡UI...');
                
                this.towerCardUI = new TowerCardUITest(this);
                this.towerCardUI.create();
                
                console.log('âœ… å¡”å¡ç‰‡UIå‰µå»ºå®Œæˆ');
            }
            
            createTowerPlacementSystem() {
                console.log('ğŸ—ï¸ å‰µå»ºå¡”æ”¾ç½®ç³»çµ±...');
                
                this.towerPlacementSystem = new TowerPlacementSystemTest(this);
                this.towerPlacementSystem.create();
                
                console.log('âœ… å¡”æ”¾ç½®ç³»çµ±å‰µå»ºå®Œæˆ');
            }
            
            createMoneyDisplay() {
                const moneyText = this.add.text(20, 20, `é‡‘éŒ¢: $${this.player.money}`, {
                    fontSize: '24px',
                    fill: '#ffd93d',
                    fontWeight: 'bold',
                    backgroundColor: '#000000',
                    padding: { x: 10, y: 5 }
                });
                moneyText.setDepth(2000);
                
                // å°‡å…ƒç´ æ·»åŠ åˆ° DOM ä»¥ä¾¿å¤–éƒ¨æ§åˆ¶
                const moneyElement = document.createElement('div');
                moneyElement.id = 'money-display';
                moneyElement.textContent = `é‡‘éŒ¢: $${this.player.money}`;
                moneyElement.style.position = 'absolute';
                moneyElement.style.top = '20px';
                moneyElement.style.left = '20px';
                moneyElement.style.color = '#ffd93d';
                moneyElement.style.fontSize = '18px';
                moneyElement.style.fontWeight = 'bold';
                moneyElement.style.backgroundColor = 'rgba(0,0,0,0.7)';
                moneyElement.style.padding = '5px 10px';
                moneyElement.style.borderRadius = '5px';
                document.body.appendChild(moneyElement);
            }
            
            onTowerCardSelected(data) {
                const { type, name, cost } = data;
                console.log(`ğŸ¯ é¸æ“‡äº†å¡”å¡ç‰‡: ${name} (${type}) - åƒ¹æ ¼: $${cost}`);
                
                // èª¿è©¦ä¿¡æ¯
                console.log('ğŸ” èª¿è©¦ä¿¡æ¯:');
                console.log('  - ç©å®¶å°è±¡:', this.player);
                console.log('  - ç©å®¶é‡‘éŒ¢:', this.player ? this.player.money : 'undefined');
                console.log('  - å¡”æ”¾ç½®ç³»çµ±:', this.towerPlacementSystem);
                console.log('  - å¡”å¡ç‰‡UI:', this.towerCardUI);
                
                // æª¢æŸ¥ç©å®¶æ˜¯å¦æœ‰è¶³å¤ çš„é‡‘éŒ¢
                if (this.player && this.player.money >= cost) {
                    console.log(`âœ… é‡‘éŒ¢æª¢æŸ¥é€šé: ç©å®¶æœ‰ $${this.player.money}ï¼Œéœ€è¦ $${cost}`);
                    
                    // é–‹å§‹å¡”æ”¾ç½®æ¨¡å¼
                    if (this.towerPlacementSystem) {
                        console.log(`ğŸš€ èª¿ç”¨ startTowerPlacement(${type})`);
                        this.towerPlacementSystem.startTowerPlacement(type);
                        
                        console.log(`âœ… é–‹å§‹æ”¾ç½® ${type} å¡”`);
                    } else {
                        console.error('âŒ å¡”æ”¾ç½®ç³»çµ±æœªåˆå§‹åŒ–');
                    }
                } else {
                    const reason = !this.player ? 'ç©å®¶å°è±¡ä¸å­˜åœ¨' : 
                                  this.player.money < cost ? `é‡‘éŒ¢ä¸è¶³ (æœ‰$${this.player.money}ï¼Œéœ€è¦$${cost})` : 'æœªçŸ¥åŸå› ';
                    console.warn(`âŒ ç„¡æ³•è³¼è²· ${name}: ${reason}`);
                    
                    // å–æ¶ˆå¡ç‰‡é¸æ“‡
                    if (this.towerCardUI) {
                        this.towerCardUI.deselectAll();
                    }
                }
            }
        }

        // ç°¡åŒ–ç‰ˆçš„ TowerCardUI ç”¨æ–¼æ¸¬è©¦
        class TowerCardUITest {
            constructor(scene) {
                this.scene = scene;
                this.cards = [];
                this.selectedCard = null;
                this.cardSpacing = 20;
                this.cardWidth = 97;
                this.cardHeight = 129;
                this.uiHeight = 130;
                
                this.towerTypes = [
                    { type: 'basic', name: 'åŸºç¤å¡”', cardFrame: 'basic-tower-card.png', cost: 50 },
                    { type: 'cannon', name: 'åŠ è¾²ç‚®', cardFrame: 'canon-tower-card.png', cost: 100 },
                    { type: 'laser', name: 'æ¿€å…‰å¡”', cardFrame: 'laser-tower-card.png', cost: 150 },
                    { type: 'ice', name: 'å†°å‡å¡”', cardFrame: 'ice-tower-card.png', cost: 120 }
                ];
            }

            create() {
                console.log('ğŸ´ å‰µå»ºå¡”å¡ç‰‡é¸æ“‡å€åŸŸ...');
                
                const { width, height } = this.scene.scale.gameSize;
                const startX = this.cardSpacing;
                const cardY = height - this.uiHeight + (this.uiHeight - this.cardHeight) / 2;
                
                // å‰µå»ºèƒŒæ™¯
                this.createBackground(width, height);
                
                // å‰µå»ºæ¯å€‹å¡”å¡ç‰‡
                this.towerTypes.forEach((towerConfig, index) => {
                    const cardX = startX + index * (this.cardWidth + this.cardSpacing);
                    const card = this.createTowerCard(cardX, cardY, towerConfig, index);
                    this.cards.push(card);
                });
                
                console.log(`âœ… å‰µå»ºäº† ${this.cards.length} å€‹å¡”å¡ç‰‡`);
            }

            createBackground(width, height) {
                this.background = this.scene.add.rectangle(
                    width / 2, 
                    height - this.uiHeight / 2, 
                    width, 
                    this.uiHeight, 
                    0x000000, 
                    0.8
                );
                this.background.setDepth(1000);
                
                this.border = this.scene.add.rectangle(
                    width / 2,
                    height - this.uiHeight,
                    width,
                    2,
                    0x444444
                );
                this.border.setDepth(1001);
            }

            createTowerCard(x, y, towerConfig, index) {
                const card = {
                    type: towerConfig.type,
                    name: towerConfig.name,
                    cost: towerConfig.cost,
                    cardFrame: towerConfig.cardFrame,
                    index: index,
                    container: null,
                    sprite: null,
                    shadow: null,
                    highlight: null,
                    costText: null,
                    isSelected: false
                };

                card.container = this.scene.add.container(x, y);
                card.container.setDepth(1002);
                card.container.setSize(this.cardWidth, this.cardHeight);
                card.container.setInteractive();

                // é™°å½±
                card.shadow = this.scene.add.rectangle(2, 2, this.cardWidth, this.cardHeight, 0x000000, 0.3);
                card.shadow.setOrigin(0.5);
                card.container.add(card.shadow);

                // å¡ç‰‡ç²¾éˆ
                card.sprite = this.scene.add.image(0, 0, 'tower-sprites', card.cardFrame);
                card.sprite.setOrigin(0.5);
                card.container.add(card.sprite);

                // é«˜äº®æ•ˆæœ
                card.highlight = this.scene.add.rectangle(0, 0, this.cardWidth + 8, this.cardHeight + 8, 0x00ff00, 0);
                card.highlight.setStrokeStyle(3, 0x00ff00, 0.8);
                card.highlight.setOrigin(0.5);
                card.highlight.setVisible(false);
                card.container.add(card.highlight);

                // åƒ¹æ ¼æ–‡å­—
                card.costText = this.scene.add.text(0, this.cardHeight / 2 - 10, `$${card.cost}`, {
                    fontSize: '14px',
                    fill: '#ffd93d',
                    fontWeight: 'bold',
                    backgroundColor: '#000000',
                    padding: { x: 4, y: 2 }
                });
                card.costText.setOrigin(0.5);
                card.container.add(card.costText);

                // äº¤äº’äº‹ä»¶
                this.addCardInteractions(card);

                return card;
            }

            addCardInteractions(card) {
                card.container.on('pointerover', () => {
                    if (!card.isSelected) {
                        card.sprite.setScale(1.1);
                        card.shadow.setScale(1.1);
                        card.container.y -= 5;
                    }
                });

                card.container.on('pointerout', () => {
                    if (!card.isSelected) {
                        card.sprite.setScale(1.0);
                        card.shadow.setScale(1.0);
                        card.container.y += 5;
                    }
                });

                card.container.on('pointerdown', () => {
                    this.selectCard(card);
                });
            }

            selectCard(selectedCard) {
                if (this.selectedCard) {
                    this.deselectCard(this.selectedCard);
                }

                selectedCard.isSelected = true;
                selectedCard.highlight.setVisible(true);
                selectedCard.sprite.setScale(1.1);
                selectedCard.shadow.setScale(1.1);
                selectedCard.container.y -= 5;

                this.selectedCard = selectedCard;

                console.log(`ğŸ¯ é¸æ“‡äº†å¡”: ${selectedCard.name} (${selectedCard.type})`);

                this.scene.events.emit('towerCardSelected', {
                    type: selectedCard.type,
                    name: selectedCard.name,
                    cost: selectedCard.cost
                });
            }

            deselectCard(card) {
                card.isSelected = false;
                card.highlight.setVisible(false);
                card.sprite.setScale(1.0);
                card.shadow.setScale(1.0);
                card.container.y += 5;
            }

            deselectAll() {
                if (this.selectedCard) {
                    this.deselectCard(this.selectedCard);
                    this.selectedCard = null;
                }
            }
        }

        // ç°¡åŒ–ç‰ˆçš„ TowerPlacementSystem ç”¨æ–¼æ¸¬è©¦
        class TowerPlacementSystemTest {
            constructor(scene) {
                this.scene = scene;
                this.isBuilding = false;
                this.selectedTowerType = null;
                this.buildPreview = null;
            }

            create() {
                console.log('ğŸ—ï¸ åˆå§‹åŒ–å¡”æ”¾ç½®ç³»çµ±...');
                
                // è¨­ç½®äº‹ä»¶ç›£è½
                this.scene.events.on('towerCardSelected', this.scene.onTowerCardSelected, this.scene);
                
                console.log('âœ… å¡”æ”¾ç½®ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            }

            startTowerPlacement(towerType) {
                console.log(`ğŸ¯ é–‹å§‹å¡”æ”¾ç½®æ¨¡å¼: ${towerType}`);
                
                this.isBuilding = true;
                this.selectedTowerType = towerType;
                
                // å‰µå»ºé è¦½å¡”
                this.createBuildPreview();
                
                console.log(`âœ… å¡”æ”¾ç½®æ¨¡å¼å·²å•Ÿå‹•: ${towerType}`);
            }

            createBuildPreview() {
                if (this.buildPreview) {
                    this.buildPreview.destroy();
                }
                
                // å‰µå»ºé è¦½å¡”
                this.buildPreview = this.scene.add.image(640, 300, 'tower-sprites', `${this.selectedTowerType}-tower.png`);
                this.buildPreview.setScale(1.5);
                this.buildPreview.setAlpha(0.6);
                this.buildPreview.setDepth(101);
                
                // æ·»åŠ è·Ÿéš¨æ»‘é¼ çš„é‚è¼¯
                this.scene.input.on('pointermove', (pointer) => {
                    if (this.isBuilding && this.buildPreview) {
                        const worldPoint = this.scene.cameras.main.getWorldPoint(pointer.x, pointer.y);
                        this.buildPreview.setPosition(worldPoint.x, worldPoint.y);
                    }
                });
                
                // æ·»åŠ é»æ“Šæ”¾ç½®é‚è¼¯
                this.scene.input.on('pointerdown', (pointer) => {
                    if (this.isBuilding && this.buildPreview) {
                        const worldPoint = this.scene.cameras.main.getWorldPoint(pointer.x, pointer.y);
                        this.placeTower(worldPoint.x, worldPoint.y);
                    }
                });
                
                console.log('âœ… é è¦½å¡”å‰µå»ºå®Œæˆ');
            }

            placeTower(x, y) {
                console.log(`ğŸ—ï¸ åœ¨ä½ç½® (${x}, ${y}) æ”¾ç½® ${this.selectedTowerType} å¡”`);
                
                // å‰µå»ºå¯¦éš›çš„å¡”
                const tower = this.scene.add.image(x, y, 'tower-sprites', `${this.selectedTowerType}-tower.png`);
                tower.setScale(1.5);
                tower.setDepth(100);
                
                // æ‰£é™¤é‡‘éŒ¢
                const cost = this.getTowerCost(this.selectedTowerType);
                this.scene.player.money -= cost;
                console.log(`ğŸ’° æ‰£é™¤ $${cost}ï¼Œå‰©é¤˜é‡‘éŒ¢: $${this.scene.player.money}`);
                
                // å–æ¶ˆæ”¾ç½®æ¨¡å¼
                this.cancelBuilding();
                
                console.log(`âœ… ${this.selectedTowerType} å¡”æ”¾ç½®å®Œæˆ`);
            }

            getTowerCost(towerType) {
                const costs = {
                    basic: 50,
                    cannon: 100,
                    laser: 150,
                    ice: 120
                };
                return costs[towerType] || 100;
            }

            cancelBuilding() {
                this.isBuilding = false;
                this.selectedTowerType = null;
                
                if (this.buildPreview) {
                    this.buildPreview.destroy();
                    this.buildPreview = null;
                }
                
                // å–æ¶ˆå¡ç‰‡é¸æ“‡
                if (this.scene.towerCardUI) {
                    this.scene.towerCardUI.deselectAll();
                }
                
                console.log('âŒ å¡”æ”¾ç½®æ¨¡å¼å·²å–æ¶ˆ');
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 962,
            parent: 'game-container',
            backgroundColor: '#2c3e50',
            scene: TowerPlacementTestScene
        };

        const game = new Phaser.Game(config);
        window.game = game;
    </script>
</body>
</html>
